name: ðŸš€ Screenshot Testing CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  screenshot-testing:
    name: Automated Screenshot Testing
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1

    - name: Install dependencies
      run: bun install

    - name: Build Astro site
      run: bun run build

    - name: Start static server
      run: bunx http-server dist -p 4324 &
      shell: bash

    - name: Set up Docker
      uses: docker/setup-buildx-action@v3

    - name: Start Docker Chrome container
      run: |
        docker compose up -d
        
    - name: Wait for services to be ready
      run: |
        echo "Waiting for Selenium Grid..."
        for i in {1..30}; do
          if curl -s http://localhost:4444 > /dev/null; then
            echo "Selenium Grid is ready"
            break
          fi
          echo "Waiting for Selenium Grid... ($i/30)"
          sleep 2
        done
        
        echo "Waiting for web server..."
        for i in {1..30}; do
          if curl -s http://localhost:4324 > /dev/null; then
            echo "Web server is ready"
            break
          fi
          echo "Waiting for web server... ($i/30)"
          sleep 1
        done

    - name: Create screenshots directory
      run: mkdir -p screenshots

    - name: Run selenium screenshot tests
      run: bun run test:selenium:ci
      continue-on-error: true
      env:
        SELENIUM_HOST: localhost
        SELENIUM_PORT: 4444
        BASE_URL: http://localhost:4324

    - name: Upload screenshots as artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: screenshots-${{ github.run_number }}
        path: screenshots/
        retention-days: 7

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ github.run_number }}
        path: |
          logs/
          tests_output/
        retention-days: 7

    - name: Container logs
      if: always()
      run: docker compose logs chrome